<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Ball Game</title>
<style>
:root{--bg:#0b0b0b;--yellow:#FFD400;--muted:#ddd;}
html,body{height:100%;margin:0;background:var(--bg);color:var(--muted);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
canvas{display:block;background:transparent}
#ui{position:absolute;left:0;right:0;bottom:0;padding:12px;display:flex;gap:8px;flex-wrap:wrap;justify-content:center;align-items:center;background:rgba(0,0,0,0.6);border-top:3px solid var(--yellow);box-sizing:border-box;z-index:30;}
.btn{background:linear-gradient(#111,#0e0e0e);color:var(--yellow);border:3px solid var(--yellow);padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:700;min-width:120px;text-align:center;user-select:none;}
.btn:active{transform:translateY(1px);}
#counter{position:absolute;top:14px;left:14px;display:flex;align-items:center;gap:10px;z-index:40;background:rgba(0,0,0,0.35);border:3px solid var(--yellow);padding:8px 12px;border-radius:12px;font-size:22px;color:var(--yellow);}
#lastBall{width:36px;height:36px;border-radius:50%;border:3px solid #fff;background:#333;box-shadow:0 0 8px rgba(255,212,0,0.12);}
.small-note{font-size:12px;color:#bbb;margin-top:4px;text-align:center}
@media(max-width:420px){.btn{min-width:110px;padding:12px;font-size:15px;border-radius:12px;}#counter{font-size:20px;padding:8px;border-radius:10px;}#lastBall{width:40px;height:40px}}
</style>
</head>
<body>
<canvas id="canvas"></canvas>

<div id="counter">
  <div id="lostBalls">0</div>
  <div id="lastBall" title="Last lost ball color"></div>
</div>

<div id="ui">
  <div class="btn" onclick="buyExtraBall()">Buy Extra Ball (1)</div>
  <div class="btn" onclick="removeSide()">Remove Side (2)</div>
  <div class="btn" onclick="spawnShape()">Spawn Shape (3)</div>
  <div class="btn" onclick="speedUpBalls()">Speed Up (2)</div>
  <div class="btn" onclick="increaseRadius()">Bigger Polygon (3)</div>
  <div class="btn" onclick="doubleSpawn()">Double Spawn (5)</div>
  <div class="btn" onclick="buyShield()">Shield (4)</div>

  <div class="btn" onclick="biggerBalls()">Bigger Balls (10)</div>
  <div class="btn" onclick="slowField()">Slow Field (12)</div>
  <div class="btn" onclick="nuke()">Nuke (80)</div>
  <div class="btn" onclick="magnetize()">Magnetize (40)</div>

  <div class="btn" onclick="summonCar()">??? (150)</div>
  <div class="btn" onclick="cloneSwarm()">Clone Swarm (20)</div>
  <div class="btn" onclick="blackHole()">Black Hole (25)</div>
</div>

<div style="position: absolute; left:14px; top:72px; color:#bbb; font-size:13px; z-index:40;">
  <div class="small-note">Spawn multiplier: <span id="spawnMult">2</span></div>
  <div class="small-note">Ball size x: <span id="ballSizeMul">1.0</span></div>
</div>

<div id="boomGif" style="
    position:absolute;
    width:300px;
    height:auto;
    left:-9999px;
    top:-9999px;
    z-index:99999;
    pointer-events:none;
">
   <img src="/assets/images/explosion.gif" style="width:100%;height:auto;">
</div>

<script>
const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d');
const CAR_SIZE = 600; // new car size

let polygon=3,radiusFrac=0.26,radius=0,baseSpeedFactor=0.0045,baseSpeed=0;
let center={x:0,y:0};
let lostBallsCount = 1000, lastBallColor = '#ff4444';
let prevLostBallsCount = lostBallsCount; 
const lostBallsEl=document.getElementById('lostBalls');
const lastBallEl=document.getElementById('lastBall');
const spawnMultEl=document.getElementById('spawnMult');
const ballSizeMulEl=document.getElementById('ballSizeMul');
const hitSound = new Audio('/assets/audio/hit.mp3');        // ball hits polygon
const getOutSound = new Audio('/assets/audio/getout.mp3');  // ball flies out
const runOverSound = new Audio('/assets/audio/runover.mp3'); // car button pressed
const crashSound = new Audio('/assets/audio/crash.mp3');     // car appears
const explosionSound = new Audio('/assets/audio/explosion.mp3'); // car leaves screen
const splatSound = new Audio('/assets/audio/splat.mp3');    // ball squished

let spawnMultiplier=2,shieldUses=0;
let gravityActive=false,gravityPoint={x:0,y:0},gravityTime=0;
let chaosActive=false,chaosTime=0;
let warpActive=false,warpTime=0;
let blackHoleActive=false,blackHoleTime=0;
let slowActive=false,slowTime=0;
let biggerBallsActive=false,biggerBallsTime=0;
let magnetActive=false,magnetTime=0;
let lastHitTime = 0;
let lastSplatTime = 0;
// Track previous lost count to detect increments
let carAudioActive = false;
const normalVolume = 1.0;  // regular volume for all sounds
const dimmedVolume = 0.02; // dim other sounds during car events

function dimOtherSounds(active) {
    const volume = active ? dimmedVolume : normalVolume;
    hitSound.volume = volume;
    getOutSound.volume = volume;
    // splatSound is intentionally left alone
}

const cars=[]; // secret cars
const magnets=[];

const MAX_BALLS=700;
let ballSizeMultiplier=1.0;

function clamp(v,a,b){return Math.max(a,Math.min(b,v));}
function randomNonGreenColor(){let hue,tries=0;while(true){hue=Math.floor(Math.random()*360);if(!(hue>=80&&hue<=160))break;if(++tries>30)break;}return `hsl(${hue},82%,56%)`;}
function makeBallAtCenter(){const a=Math.random()*Math.PI*2,speed=baseSpeed*(0.85+Math.random()*0.5);return{x:center.x,y:center.y,vx:Math.cos(a)*speed,vy:Math.sin(a)*speed,color:randomNonGreenColor(),flattened:false,flattenTime:0};}


let balls=[];
function fit(){canvas.width=window.innerWidth;canvas.height=window.innerHeight;radius=Math.min(canvas.width,canvas.height)*radiusFrac;center.x=canvas.width/2;center.y=canvas.height/2;}
window.addEventListener('resize',fit);

function init(){fit();baseSpeed=Math.min(canvas.width,canvas.height)*baseSpeedFactor;balls=[makeBallAtCenter()];updateUI();}
function updateUI(){lostBallsEl.textContent=lostBallsCount;lastBallEl.style.background=lastBallColor;spawnMultEl.textContent=spawnMultiplier;ballSizeMulEl.textContent=ballSizeMultiplier.toFixed(2);}

// basic upgrades
function buyExtraBall(){if(lostBallsCount>=1){lostBallsCount-=1;balls.push(makeBallAtCenter());updateUI();}}
function removeSide(){if(lostBallsCount>=2&&polygon>3){lostBallsCount-=2;polygon--;updateUI();}}
function spawnShape(){if(lostBallsCount>=3){lostBallsCount-=3;for(let i=0;i<3;i++)balls.push(makeBallAtCenter());updateUI();}}
function speedUpBalls(){if(lostBallsCount>=2){lostBallsCount-=2;for(const b of balls){b.vx*=1.35;b.vy*=1.35;}updateUI();}}
function increaseRadius(){if(lostBallsCount>=3){lostBallsCount-=3;radiusFrac=clamp(radiusFrac+0.05,0.12,0.6);radius=Math.min(canvas.width,canvas.height)*radiusFrac;updateUI();}}
function doubleSpawn(){if(lostBallsCount>=5){lostBallsCount-=5;spawnMultiplier=spawnMultiplier===2?4:2;updateUI();}}
function buyShield(){if(lostBallsCount>=4){lostBallsCount-=4;shieldUses++;updateUI();}}

// new upgrades
function biggerBalls(){if(lostBallsCount>=10){lostBallsCount-=10;ballSizeMultiplier=clamp(ballSizeMultiplier+0.45,1.0,4.0);updateUI();}}
function slowField(){if(lostBallsCount>=12){lostBallsCount-=12;slowActive=true;slowTime=900;updateUI();}}
function nuke(){if(lostBallsCount>=80){lostBallsCount-=80;const toRemove=Math.floor(balls.length*0.3);for(let i=0;i<toRemove;i++){const b=balls.shift();if(b){lostBallsCount++;lastBallColor=b.color;lastBallEl.style.background=lastBallColor;for(let s=0;s<spawnMultiplier;s++)balls.push(makeBallAtCenter());}}updateUI();}}
function magnetize(){if(lostBallsCount>=40){lostBallsCount-=40;magnets.push({x:Math.random()*canvas.width,y:Math.random()*canvas.height,strength:1.2,life:900});updateUI();}}
function cloneSwarm(){if(lostBallsCount>=20){lostBallsCount-=20;const clones=[];for(const b of balls)clones.push({...b,vx:b.vx*0.5,vy:b.vy*0.5});balls.push(...clones);updateUI();}}
function blackHole(){if(lostBallsCount>=25){lostBallsCount-=25;blackHoleActive=true;blackHoleTime=800;updateUI();}}
function gravityWell(){if(lostBallsCount>=10){lostBallsCount-=10;gravityActive=true;gravityTime=700;gravityPoint={x:Math.random()*canvas.width,y:Math.random()*canvas.height};updateUI();}}
function chaosSpin(){if(lostBallsCount>=12){lostBallsCount-=12;chaosActive=true;chaosTime=700;updateUI();}}
function timeWarp(){if(lostBallsCount>=15){lostBallsCount-=15;warpActive=true;warpTime=350;for(const b of balls){b.vx*=1.45;b.vy*=1.45;}updateUI();}}

// secret car
const carImage = new Image();
carImage.src = '/assets/images/he.png'; 
const slowCarImage = new Image();
slowCarImage.src = '/assets/images/he2.png';
let pendingFastCar = false;
let slowCarActive = false;
function summonCar(){
    if(lostBallsCount < 150) return;
    lostBallsCount -= 150;
    updateUI();

    // 10% chance slow car
    const roll = Math.random() < 0.4;

    carAudioActive = true;
    dimOtherSounds(true);

    runOverSound.currentTime = 0;
    runOverSound.play();

    runOverSound.onended = () => {
        if(roll){
            // spawn slow cursed car
            const c = {
                x: -CAR_SIZE,
                y: center.y,
                vx: 2,            // slow car speed
                life: 5000,
                slow: true,
                image: slowCarImage
            };
            cars.push(c);
            slowCarActive = true;

            crashSound.currentTime = 0;
            crashSound.play();

            crashSound.onended = () => {
                carAudioActive = false;
                dimOtherSounds(false);
            };

        } else {
            // spawn normal car
            cars.push({
                x: -CAR_SIZE,
                y: center.y,
                vx: 10,
                life: 1400,
                slow: false,
                image: carImage
            });

            crashSound.currentTime = 0;
            crashSound.play();
            crashSound.onended = () => {
                carAudioActive = false;
                dimOtherSounds(false);
            };
        }
    };
}

// geometry
function getPolygonVertices(sides,r,cx,cy){const verts=[];for(let i=0;i<sides;i++){const angle=(2*Math.PI/sides)*i-Math.PI/2;verts.push({x:cx+r*Math.cos(angle),y:cy+r*Math.sin(angle)});}return verts;}
function pointLineDistance(px,py,x1,y1,x2,y2){const A=px-x1,B=py-y1,C=x2-x1,D=y2-y1,dot=A*C+B*D,len_sq=C*C+D*D;let param=len_sq!==0?dot/len_sq:-1;let xx,yy;if(param<0){xx=x1;yy=y1;}else if(param>1){xx=x2;yy=y2;}else{xx=x1+C*param;yy=y1+D*param;}const dx=px-xx,dy=py-yy;return Math.sqrt(dx*dx+dy*dy);}
function drawPolygon(vertices){ctx.beginPath();ctx.moveTo(vertices[0].x,vertices[0].y);for(let i=1;i<vertices.length;i++)ctx.lineTo(vertices[i].x,vertices[i].y);ctx.closePath();ctx.strokeStyle="#FFD400";ctx.lineWidth=Math.max(3,Math.min(14,Math.round(Math.min(canvas.width,canvas.height)*0.012)));ctx.stroke();}

// main loop
function animate(){
  radius=Math.min(canvas.width,canvas.height)*radiusFrac;
  baseSpeed=Math.min(canvas.width,canvas.height)*baseSpeedFactor;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const verts=getPolygonVertices(polygon,radius,center.x,center.y);
  drawPolygon(verts);

  const next=[];
  const toSpawn=[];

// === CLEAN & FIXED CAR SYSTEM ===
for (let i = cars.length - 1; i >= 0; i--) {
    const c = cars[i];

    // Move car
    c.x += c.vx;
    if (!c.yeeted) c.life--;

    // Draw car
    const img = c.image || carImage;
    if (img.complete) {
        ctx.drawImage(img, c.x - CAR_SIZE/2, c.y - CAR_SIZE/2, CAR_SIZE, CAR_SIZE);
    }

    // ——— SLOW CAR: trigger fast car ONLY when entering polygon center ———
    if (c.slow && !c.intercepted) {
        if (c.x >= center.x - CAR_SIZE * 0.2) {
            c.intercepted = true;

            // spawn fast interceptor
            cars.push({
                x: -CAR_SIZE,
                y: c.y,
                vx: 20,
                life: 2000,
                slow: false,
                target: c,
                image: carImage
            });

            crashSound.currentTime = 0;
            crashSound.play();
        }
    }

    // ——— FAST CAR CHASE ———
    if (c.target && !c.target.yeeted) {

        // fast car moves toward target
        if (c.x < c.target.x) c.vx = 20;

        // collision
        if (Math.abs(c.x - c.target.x) < CAR_SIZE * 0.5) {

           // play the audio immediately
explosionSound.currentTime = 0;
explosionSound.play();

// explosion gif container
const boom = document.getElementById("boomGif");
const boomImg = boom.querySelector("img");

// crash position
const boomX = c.target.x - 150;
const boomY = c.target.y - 150;

// delay GIF spawn so it's synced with the loud part
setTimeout(() => {

    // restart the gif animation ALWAYS
    const oldSrc = boomImg.src;
    boomImg.src = "";
    boomImg.src = oldSrc;

    boom.style.left = boomX + "px";
    boom.style.top = boomY + "px";

    // hide after 900ms
    setTimeout(() => boom.style.left = "-9999px", 900);

}, 180); // <-- delay here, adjust as needed

            // YEET slow car upward
            c.target.yeeted = true;
            c.target.vx = 0;
            c.target.vy = -25;

            // remove fast car
            cars.splice(i, 1);
            continue;
        }
    }

    // ——— YEETED SLOW CAR ———
    if (c.yeeted) {
        c.y += c.vy;
        c.vy *= 0.99;

        if (c.y < -CAR_SIZE * 2) {
            cars.splice(i, 1);
            continue;
        }
    }

    // ——— BALL SQUISH CHECK (shared) ———
    for (let b of balls) {
        if (b.squished) continue;

        const dx = b.x - c.x;
        const dy = b.y - c.y;
        const dist = Math.sqrt(dx*dx + dy*dy);

        const hitDist = (CAR_SIZE * 0.35) + (radius * 0.09 * ballSizeMultiplier);

        if (dist < hitDist) {
            b.squished = true;
            b.squishTime = 180;
            b.vx = 0;
            b.vy = 0;
            b.splatPlayed = false;
        }
    }
}
// balls
for(const b of balls){  
    if(b.squished){  
        // draw squished ball
        const br = Math.max(6, radius*0.09) * ballSizeMultiplier;  
        ctx.beginPath();  
        ctx.ellipse(b.x, b.y, br, br*0.3, 0, 0, Math.PI*2); // flattened vertically  
        ctx.fillStyle = b.color;  
        ctx.fill();  
        ctx.lineWidth = Math.max(1, Math.round(br*0.12));  
        ctx.strokeStyle = 'rgba(0,0,0,0.25)';  
        ctx.stroke();  

        // play splat sound once
        if(!b.splatPlayed){
            splatSound.currentTime = 0;
            splatSound.play();
            b.splatPlayed = true;
        }

        b.squishTime--;  
        if(b.squishTime <= 0){  
    lostBallsCount++; // count as lost  
    lastBallColor = b.color;  
    lastBallEl.style.background = lastBallColor;  

    // only play getOut sound if ball wasn't squished
    if(!b.squished){
        getOutSound.currentTime = 0;
        getOutSound.play();
    }

            continue; // skip adding it AFTER it dies
        } else {
            next.push(b); // keep squished ball in play until timer ends
        }
    } else {  
        // normal ball movement & drawing
        let vx=b.vx, vy=b.vy;  
        if(slowActive){vx*=0.6; vy*=0.6;}  
        if(gravityActive){  
            let dx=gravityPoint.x-b.x, dy=gravityPoint.y-b.y, dist=Math.sqrt(dx*dx+dy*dy)+0.1, f=0.9/dist;  
            vx+=dx*f; vy+=dy*f;  
        }  
        for(const m of magnets){  
            const dx=m.x-b.x, dy=m.y-b.y, d=Math.sqrt(dx*dx+dy*dy)+0.1, v=(m.strength*2)/(d*d)*0.001;  
            vx+=dx*v; vy+=dy*v;  
        }  
        if(chaosActive){  
            const ang=Math.atan2(b.y-center.y,b.x-center.x)+0.04*(Math.random()*1.5);  
            const r=Math.sqrt((b.x-center.x)**2+(b.y-center.y)**2);  
            b.x=center.x+Math.cos(ang)*r;  
            b.y=center.y+Math.sin(ang)*r;  
        } else {  
            b.x+=vx; b.y+=vy;  
        }  

        // polygon collision
        for(let i=0;i<verts.length;i++){  
            const n=verts[(i+1)%verts.length];  
            const dist=pointLineDistance(b.x,b.y,verts[i].x,verts[i].y,n.x,n.y);  
            if(dist<radius*0.055){  
                let nx=n.y-verts[i].y, ny=-(n.x-verts[i].x);  
                const llen=Math.sqrt(nx*nx+ny*ny)||1; nx/=llen; ny/=llen;  
                const dot=vx*nx+vy*ny;  
                b.vx=vx-2*dot*nx; b.vy=vy-2*dot*ny;  
                b.vx*=1.06; b.vy*=1.06;  
                polygon++;  

                // play hit sound (throttle to prevent spam)
                const now = performance.now();
                if(now - lastHitTime > 50){
                    hitSound.currentTime = 0;
                    hitSound.play();
                    lastHitTime = now;
                }

                break;  
            }  
        }  

        const margin=radius*0.9;  
        if(b.x<-margin||b.x>canvas.width+margin||b.y<-margin||b.y>canvas.height+margin){  
            lostBallsCount++;  
            lastBallColor=b.color;  
            lastBallEl.style.background=lastBallColor;  
            for(let s=0;s<spawnMultiplier;s++) toSpawn.push(makeBallAtCenter());  
            if(shieldUses>0) shieldUses--; else if(polygon>3) polygon--;  

            // play getOut sound
            getOutSound.currentTime = 0;
            getOutSound.play();

        } else {  
            next.push(b);  
            const br=Math.max(6,radius*0.09)*ballSizeMultiplier;  
            ctx.beginPath(); ctx.arc(b.x,b.y,br,0,Math.PI*2);  
            ctx.fillStyle=b.color; ctx.fill();  
            ctx.lineWidth=Math.max(1,Math.round(br*0.12));  
            ctx.strokeStyle='rgba(0,0,0,0.25)'; ctx.stroke();  
        }  
    }  
}

if(toSpawn.length) next.push(...toSpawn);

  // magnets lifetime
  for(let i=magnets.length-1;i>=0;i--){magnets[i].life--;if(magnets[i].life<=0)magnets.splice(i,1);}

  // timers
  if(gravityActive){gravityTime--;if(gravityTime<=0)gravityActive=false;}
  if(chaosActive){chaosTime--;if(chaosTime<=0)chaosActive=false;}
  if(warpActive){warpTime--;if(warpTime<=0)warpActive=false;}
  if(blackHoleActive){blackHoleTime--;if(blackHoleTime<=0)blackHoleActive=false;}
  if(slowActive){slowTime--;if(slowTime<=0)slowActive=false;}
  if(biggerBallsActive){biggerBallsTime--;if(biggerBallsTime<=0)biggerBallsActive=false;}

  if(next.length>MAX_BALLS)next.splice(0,next.length-MAX_BALLS);
  balls=next;
  updateUI();
  requestAnimationFrame(animate);
}

fit();
animate();
</script>
</body>
</html>
